# ==============================================================================
# Docker Compose Stack: Nextcloud (existing) + OpenAI-powered services
# Target: Radxa ARM64 (16GB RAM)
#
# CRITICAL: This file preserves existing Nextcloud configuration and data.
# - The original nextcloud-db (PostgreSQL 15) remains unchanged for compatibility.
# - A new shared PostgreSQL (pgvector/pgvector:pg17) is added for AI apps.
# - Nextcloud continues to function exactly as before (port 9991, volumes unchanged).
#
# Key Ports:
# - 9991: Nextcloud (existing)
# - 9992: n8n
# - 9993: SurfSense Backend
# - 9994: SurfSense Frontend
# - 9995: Open WebUI
# - 9996: ComfyUI
# - 9997: Presenton
# - 9998: OpenUI
#
# Networks:
# - nas_network: existing network for Nextcloud stack
# - ai_network: new network for AI services
#
# Security:
# - No external exposure of any database ports
# - n8n uses basic auth
# - SurfSense uses NextAuth
# - All services accept OPENAI_API_KEY from .env
# ==============================================================================

services:
  # ============================================================================
  # EXISTING NEXTCLOUD SERVICES (DO NOT MODIFY)
  # ============================================================================

  nextcloud:
    image: nextcloud:latest
    platform: linux/arm64
    container_name: nas_nextcloud
    restart: unless-stopped
    ports:
      - "9991:80"
    env_file:
      - .env
    environment:
      - TRUSTED_PROXIES=172.16.0.0/12 192.168.0.0/16 10.0.0.0/8 100.90.95.111 100.71.243.53
      - OVERWRITECLIURL=https://nas.soundsgoodlab.sg
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - PHP_MEMORY_LIMIT=4G
      - PHP_UPLOAD_LIMIT=16G
    volumes:
      - ./nextcloud/html:/var/www/html
      - /mnt/storage/nextcloud:/var/www/html/data
    depends_on:
      nextcloud-db:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/status.php" ]
      interval: 30s
      timeout: 10s
      retries: 10
    networks:
      - nas_network

  nextcloud-cron:
    image: nextcloud:latest
    platform: linux/arm64
    container_name: nas_nextcloud_cron
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./nextcloud/html:/var/www/html
      - /mnt/storage/nextcloud:/var/www/html/data
    entrypoint: /cron.sh
    depends_on:
      - nextcloud-db
      - redis
    networks:
      - nas_network

  nextcloud-db:
    image: postgres:15-alpine
    platform: linux/arm64
    container_name: nas_nextcloud_db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
    volumes:
      - ./nextcloud/db:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U nextcloud -d nextcloud" ]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - nas_network

  redis:
    image: redis:alpine
    platform: linux/arm64
    container_name: nas_redis
    restart: unless-stopped
    env_file:
      - .env
    command: [ "redis-server", "--requirepass", "${REDIS_PASSWORD}" ]
    volumes:
      - ./nextcloud/redis:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "PING" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nas_network

  # ============================================================================
  # NEW AI SERVICES
  # ============================================================================

  # Shared PostgreSQL (pgvector) for AI services
  postgres:
    image: pgvector/pgvector:pg17
    platform: linux/arm64
    container_name: ai_postgres
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=postgres
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./pgvector-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d postgres" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ai_network

  # n8n - Workflow Automation (Port 9992)
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    platform: linux/arm64
    container_name: ai_n8n
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_HOST=0.0.0.0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NODE_OPTIONS=--max-old-space-size=512
    ports:
      - "9992:5678"
    volumes:
      - ./data/n8n:/home/node/.n8n
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ai_network

  # SurfSense Backend (Port 9993)
  surfsense_backend:
    image: modsetter/surfsense-backend:latest
    platform: linux/arm64
    container_name: ai_surfsense_backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/surfsense
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LITELLM_MODEL=openai/gpt-4o
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
    ports:
      - "9993:8000"
    volumes:
      - ./data/surfsense/backend:/app/data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ai_network

  # SurfSense Frontend (Port 9994)
  surfsense_frontend:
    image: modsetter/surfsense-frontend:latest
    platform: linux/arm64
    container_name: ai_surfsense_frontend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - NEXT_PUBLIC_API_URL=http://surfsense_backend:8000
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
    ports:
      - "9994:3000"
    depends_on:
      - surfsense_backend
    networks:
      - ai_network

  # Open WebUI - Voice Chat (Port 9995)
  open_webui:
    image: ghcr.io/open-webui/open-webui:main
    platform: linux/arm64
    container_name: ai_open_webui
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENABLE_OPENAI_API=true
      - WHISPER_MODEL=whisper-1
      - TTS_VOICE=alloy
      - TRANSFORMERS_CACHE_HOME=/tmp
      - HF_HOME=/tmp
      - SENTENCE_TRANSFORMERS_HOME=/tmp
    ports:
      - "9995:8080"
    volumes:
      - ./data/open_webui:/app/backend/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ai_network

  # ComfyUI - Image Generation (Port 9996)
  comfyui:
    image: yanwk/comfyui-boot:latest
    platform: linux/arm64
    container_name: ai_comfyui
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - CLI_ARGS=--cpu --listen 0.0.0.0 --port 8188
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "9996:8188"
    volumes:
      - ./data/comfyui/storage:/root
      - ./data/comfyui/config:/root/.comfyui
    networks:
      - ai_network

  # Presenton - AI Presentations (Port 9997)
  presenton:
    image: presenton/presenton:latest
    platform: linux/arm64
    container_name: ai_presenton
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/presenton
    ports:
      - "9997:3000"
    volumes:
      - ./data/presenton:/app/data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ai_network

  # OpenUI - UI Generation (Port 9998)
  openui:
    image: ghcr.io/wandb/openui:latest
    platform: linux/arm64
    container_name: ai_openui
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "9998:7878"
    volumes:
      - ./data/openui:/app/data
    networks:
      - ai_network

# ==============================================================================
# Networks
# ==============================================================================
networks:
  nas_network:
    driver: bridge
  ai_network:
    driver: bridge
